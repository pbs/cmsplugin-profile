{% load i18n admin_static %}
{% spaceless %}
<div class="inline-group" id="{{ inline_admin_formset.formset.prefix }}-group">
{{ inline_admin_formset.formset.management_form }}
{{ inline_admin_formset.formset.non_form_errors }}
	<div id='{{ inline_admin_formset.formset.prefix }}-group-grid' class="grid-list">

		{% for inline_admin_form in inline_admin_formset %}
		{% include "admin/profile/profile_form.html" with form=inline_admin_form.form %}
		{% endfor %}
		<div class="add-new-profile-btn">
			<a class="add-row" id="add_new_profile" href="javascript:void(0)">
				<span class="add-btn ace-icon fa fa-plus" unselectable="on"></span>
				<span class="add-text" unselectable="on">Add new profile</span>
			</a>
		</div>
		<div class="new-profile-form"></div>
	</div>
	<div class="overlay"></div>
</div>

<script type="text/javascript">
(function($) {
	$(document).ready(function() {
		$("#add_new_profile").click(function(e) {
			var self = this;
			new_form_index = $('.inline-related').length -1;
			profile_grid_id = $("#id_profile_set-__prefix__-profile_plugin").attr('value');
			url = '/cmsplugin_profile/new_profile/' + new_form_index + '/';
			if (profile_grid_id !== undefined)
				url += "?profilegrid_id=" + profile_grid_id;
			jQuery.ajax({
				url: url,
				success: function (response) {
					$('#profile_set-group-grid .new-profile-form').addClass('visible').append(response);
					$('.overlay').addClass('visible');
					total = $('#id_profile_set-TOTAL_FORMS')[0];
					total.value = parseInt(total.value) + 1;
				},
				error: function (response) {
				}
			});
		});
		$(document).on('click', '.add-profile-link', function(e) {
			link = e.currentTarget;
			prefix = link.attributes["data-prefix"].value;
			current = parseInt(link.attributes["data-current"].value);
			next_link = $("#"+prefix+current+"container")[0];
			if(next_link != undefined) {
				next_link.style.display="block";
				link.attributes["data-current"].value=current+1;
			}
		});
		$(document).on('click', '.save-profile', function(e) {
			save_link = $(this);
			profile_grid_id = $("#id_profile_set-__prefix__-profile_plugin").attr('value');
			if (profile_grid_id===undefined)
				return;
			save_btn = e.currentTarget;
			profile_prefix = save_btn.attributes["data-profile-id"].value;
			prefix = "#id_" + profile_prefix + "-";
			id_input = $(prefix + "id")[0];
			if (id_input !== undefined) {
				id = id_input.value
			} else {
				id = ""
			}
			data = {
				"id": id,
				"title": $(prefix + "title")[0].value || "",
				"description": $(prefix + "description")[0].value || "",
				"call_to_action_text": $(prefix + "call_to_action_text")[0].value || "",
				"call_to_action_url": $(prefix + "call_to_action_url")[0].value || "",
				"additional_links_label": $(prefix + "additional_links_label")[0].value || "",
				"image_credit": $(prefix + "image_credit")[0].value || "",
				"thumbnail_image": $(prefix + "thumbnail_image")[0].value || "",
				"detail_image": $(prefix + "detail_image")[0].value || "",
			}
			link_index = 1;
			link_prefix = "#" + profile_prefix + "-links_set-";
			while(link_text=$(link_prefix + link_index + "-text")[0]) {
				link_url=$(link_prefix + link_index + "-url")[0];
				link_target=$(link_prefix + link_index + "-open_action")[0];
				link_delete=$(link_prefix + link_index + "-delete")[0];
				data["link-" + link_index + "-text"] = link_text.value;
				data["link-" + link_index + "-url"] = link_url.value;
				data["link-" + link_index + "-target"] = link_target.value;
				data["link-" + link_index + "-delete"] = link_delete.value;
				link_index ++;
			}
			jQuery.ajax({
				type: "POST",
				url: '/cmsplugin_profile/save_profile/' + profile_grid_id + "/",
				data: data,
				success: function (response) {
					if(response["status"] !== "ok"){
						return;
					}
					if (id_input === undefined) {
						id_input = '<input id="id_' + profile_prefix + '-id" name="' + profile_prefix + '-id" type="hidden" value="' + response["id"] + '">';
						$(id_input).insertBefore($(prefix + "title"));
						profile_new = $(".new-profile-form");
						$(".new-profile-form .inline-related").attr("id", profile_prefix);
						$(".new-profile-form .inline-related").attr("class", "ui-widget inline-related ui-sortable-handle");
						profile_html = profile_new.html();
						profile_new.html("");
						$(profile_html).insertBefore($(".ui-widget.inline-related.empty-form"));
					}
					save_link.closest('.visible').removeClass('visible').closest('.inline-related').removeClass('edit-mode');
					$('.overlay').removeClass('visible');
				},
			});
		});

	})
})(jQuery || django.jQuery);
</script>


{% endspaceless %}
